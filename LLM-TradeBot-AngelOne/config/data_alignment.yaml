# =====================================
# Multi-Timeframe Data Alignment Configuration
# =====================================
# Used to control real-time strategies for different timeframe data
# 
# Reference: DATA_FLOW_STRUCTURED.md - Multi-timeframe data alignment and real-time issues

# Global mode selection
mode: 'backtest'  # Options: 'backtest' | 'live_safe' | 'live_aggressive'

# Mode descriptions:
# - backtest:        All timeframes use iloc[-2] (completed candles), ensures backtest consistency
# - live_safe:       Short timeframes iloc[-1] (real-time), long timeframes iloc[-2] (stable)
# - live_aggressive: All timeframes iloc[-1] (real-time), pursuing lowest latency

# =====================================
# Detailed Mode Configuration
# =====================================

backtest:
  description: "Backtest mode - All timeframes use completed candles"
  timeframes:
    5m:
      use_realtime: false  # Use iloc[-2]
      max_lag_minutes: 10
    15m:
      use_realtime: false
      max_lag_minutes: 40
    1h:
      use_realtime: false
      max_lag_minutes: 145  # 2 hours 25 minutes

live_safe:
  description: "Live safe mode - Short timeframes real-time, long timeframes stable"
  timeframes:
    5m:
      use_realtime: true   # Use iloc[-1]
      max_lag_minutes: 5
    15m:
      use_realtime: true
      max_lag_minutes: 15
    1h:
      use_realtime: false  # Long timeframes remain stable
      max_lag_minutes: 145

live_aggressive:
  description: "Live aggressive mode - All timeframes real-time data"
  timeframes:
    5m:
      use_realtime: true
      max_lag_minutes: 5
    15m:
      use_realtime: true
      max_lag_minutes: 15
    1h:
      use_realtime: true   # Accept repaint risk
      max_lag_minutes: 60

# =====================================
# Data Timestamp Validation
# =====================================

timestamp_validation:
  enabled: true
  
  # Check if data timestamps are within reasonable range
  max_allowed_lag:
    5m: 15    # 5-minute data max lag 15 minutes (allow some network delay)
    15m: 45   # 15-minute data max lag 45 minutes
    1h: 150   # 1-hour data max lag 2.5 hours
  
  # Whether to warn if data lag exceeds threshold
  warn_on_excessive_lag: true
  
  # Whether to reject data if lag exceeds threshold
  reject_on_excessive_lag: false

# =====================================
# Repaint Risk Management
# =====================================

repaint_protection:
  enabled: true
  
  # Detect indicator changes at candle close
  track_indicator_changes: true
  
  # Whether to warn if indicator change exceeds threshold
  warn_on_significant_change:
    rsi: 5.0      # RSI change exceeds 5
    macd: 10.0    # MACD change exceeds 10%
    price: 0.5    # Price change exceeds 0.5%
  
  # Whether to revalidate signals at candle close
  revalidate_on_close: true

# =====================================
# Logging Configuration
# =====================================

logging:
  # Whether to output data timestamps in logs
  log_data_timestamps: true
  
  # Whether to output lag time in logs
  log_lag_minutes: true
  
  # Whether to mark if data is real-time in logs
  log_realtime_flag: true
  
  # Example log format:
  # [5m] price=96000 rsi=45.2 timestamp=2024-12-19T10:15:00 lag=10min realtime=false
  # [1h] price=95800 rsi=52.8 timestamp=2024-12-19T08:00:00 lag=145min realtime=false

# =====================================
# Performance Optimization
# =====================================

performance:
  # Whether to cache completed candle indicators
  cache_completed_candles: true
  
  # Cache expiration time (seconds)
  cache_ttl_seconds: 300  # 5 minutes
  
  # Whether to process multi-timeframe data in parallel
  parallel_processing: true

# =====================================
# Experimental Features
# =====================================

experimental:
  # Whether to use time-weighted alignment (adjust weights based on lag time)
  time_weighted_alignment:
    enabled: false
    weights:
      5m: 1.0    # 10-minute lag, weight 1.0
      15m: 0.8   # 40-minute lag, weight reduced to 0.8
      1h: 0.5    # 145-minute lag, weight reduced to 0.5
  
  # Whether to use extrapolation to estimate current candle (based on historical volatility)
  current_candle_estimation:
    enabled: false
    method: 'exponential_smoothing'  # 'linear' | 'exponential_smoothing'
    confidence_threshold: 0.7

# =====================================
# Usage Instructions
# =====================================
# 
# 1. Modify global mode to quickly switch modes
# 2. Or directly modify specific timeframe use_realtime configuration
# 3. Enable timestamp_validation to monitor data quality
# 4. Enable repaint_protection to detect repaint risk
# 
# Recommended configuration:
# - Backtest/validation: mode = 'backtest'
# - Conservative live: mode = 'live_safe'
# - Aggressive live: mode = 'live_aggressive' + repaint_protection.enabled = true
